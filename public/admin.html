<!doctype html>
<html lang="vi" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Ph√≤ng Kh√°m Th√†nh √ù</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    window.tailwind && (tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["Inter", "system-ui", "Segoe UI", "Roboto", "Helvetica Neue", "Arial", "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"],
          },
          colors: {
            glass: { bg: 'rgba(17,24,39,0.55)' },
          }
        }
      }
    })
  </script>
  <style>
    :root{
      --glass-bg: rgba(17,24,39,0.55);
      --glass-bd: rgba(255,255,255,0.08);
      --ring: rgba(56,189,248,0.45);
    }
    .glass{background:var(--glass-bg);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px)}
    .card{border:1px solid var(--glass-bd);border-radius:1rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.8rem;padding:.6rem 1rem;font-weight:600}
    .btn:focus{outline:none;box-shadow:0 0 0 3px var(--ring)}
    .btn-primary{background:#06b6d4;color:white}
    .btn-primary:hover{background:#0891b2}
    .btn-muted{background:#334155;color:#e5e7eb}
    .btn-muted:hover{background:#3f495a}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-danger:hover{background:#dc2626}
    .btn-success{background:#10b981;color:#fff}
    .btn-success:hover{background:#059669}
    .field{background:rgba(15,23,42,.6);border:1px solid var(--glass-bd);color:white;border-radius:.8rem;padding:.6rem .8rem;width:100%}
    .field:focus{outline:none;box-shadow:0 0 0 3px var(--ring)}

    .table-wrap{position:relative;border-top:1px solid var(--glass-bd)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:rgba(255,255,255,.06);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
    thead th, tbody td{padding:.65rem .75rem;border-bottom:1px solid var(--glass-bd)}
    tbody tr:hover{background:rgba(255,255,255,.04)}

    .chip{font-size:.75rem;line-height:1;display:inline-flex;align-items:center;padding:.35rem .55rem;border-radius:999px;border:1px solid transparent}
    .chip-open{background:rgba(16,185,129,.15);color:#34d399;border-color:rgba(16,185,129,.35)}
    .chip-closed{background:rgba(244,63,94,.12);color:#fb7185;border-color:rgba(244,63,94,.3)}

    .panelgrid{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:768px){.panelgrid{grid-template-columns: 1.1fr .9fr}}

    .toast{position:fixed;right:1rem;bottom:1rem;z-index:50;display:none}
    @media (prefers-reduced-motion: reduce){ *{animation: none !important; transition: none !important} }
  </style>
</head>
<body class="h-full bg-slate-950 text-slate-200 selection:bg-cyan-500/30">
  <header class="sticky top-0 z-20 bg-gradient-to-r from-slate-950/90 via-slate-900/90 to-slate-900/90 backdrop-blur border-b border-white/10">
    <div class="max-w-7xl mx-auto px-3 sm:px-4 py-4 flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between">
      <div class="flex items-center gap-3 min-w-0">
        <div class="h-9 w-9 grid place-content-center rounded-xl bg-cyan-500/15 text-cyan-300">ü©∫</div>
        <div class="truncate">
          <h1 class="text-base sm:text-lg font-semibold tracking-wide truncate">Admin ‚Äî Ph√≤ng Kh√°m Th√†nh √ù</h1>
          <div class="text-xs text-slate-400">Qu·∫£n l√Ω l·ªãch kh√°m theo tu·∫ßn</div>
        </div>
      </div>
      <a href="/" class="text-slate-300 hover:text-white text-sm underline-offset-2 hover:underline">Trang ch·ªß</a>
    </div>
  </header>

  <div class="fixed inset-0 -z-10 opacity-50 bg-[radial-gradient(circle_at_15%_20%,rgba(56,189,248,0.35),transparent_40%),radial-gradient(circle_at_85%_10%,rgba(99,102,241,0.35),transparent_35%),radial-gradient(circle_at_50%_90%,rgba(20,184,166,0.25),transparent_38%)]"></div>

  <main class="max-w-7xl mx-auto px-3 sm:px-4 py-6 space-y-4">
    <!-- AUTH CARD -->
    <section id="auth" class="glass card p-4 hidden">
      <form name="loginForm" onsubmit="onLogin(event)" class="space-y-3" autocomplete="on">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-slate-300 text-sm mb-1" for="email">Email</label>
            <input class="field" id="email" name="email" type="email" placeholder="admin@thanhy.vn" required />
          </div>
          <div>
            <label class="block text-slate-300 text-sm mb-1" for="password">M·∫≠t kh·∫©u</label>
            <input class="field" id="password" name="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
          </div>
          <div class="flex items-end">
            <button class="btn btn-primary w-full" type="submit">ƒêƒÉng nh·∫≠p</button>
          </div>
        </div>
      </form>
    </section>

    <!-- PANEL -->
    <section id="panel" class="space-y-4 hidden">
      <div class="panelgrid">
        <!-- Form -->
        <div class="glass card p-4 space-y-3">
          <div class="flex items-center justify-between">
            <h2 class="font-medium">T·∫°o / s·ª≠a khung gi·ªù</h2>
            <button class="btn btn-muted" type="button" onclick="logout()">ƒêƒÉng xu·∫•t</button>
          </div>

          <form name="slotForm" onsubmit="onSubmit(event)" class="space-y-3">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label class="block text-slate-300 text-sm mb-1" for="weekday">Th·ª©</label>
                <select class="field" id="weekday" name="weekday" aria-label="Ch·ªçn th·ª©">
                  <option value="1">Th·ª© 2</option>
                  <option value="2">Th·ª© 3</option>
                  <option value="3">Th·ª© 4</option>
                  <option value="4">Th·ª© 5</option>
                  <option value="5">Th·ª© 6</option>
                  <option value="6">Th·ª© 7</option>
                  <option value="0">Ch·ªß nh·∫≠t</option>
                </select>
              </div>
              <div>
                <label class="block text-slate-300 text-sm mb-1" for="start">Gi·ªù b·∫Øt ƒë·∫ßu</label>
                <input class="field" id="start" name="start" type="time" required />
              </div>
              <div>
                <label class="block text-slate-300 text-sm mb-1" for="end">Gi·ªù k·∫øt th√∫c</label>
                <input class="field" id="end" name="end" type="time" required />
              </div>
              <div>
                <label class="block text-slate-300 text-sm mb-1" for="status">Tr·∫°ng th√°i</label>
                <select class="field" id="status" name="status">
                  <option value="AVAILABLE">M·ªü</option>
                  <option value="CLOSED">ƒê√≥ng</option>
                </select>
              </div>
              <div class="md:col-span-2">
                <label class="block text-slate-300 text-sm mb-1" for="note">Ghi ch√∫</label>
                <textarea class="field min-h-[42px]" id="note" name="note" placeholder="Ghi ch√∫ th√™m (n·∫øu c√≥)"></textarea>
              </div>
            </div>
            <div class="flex flex-wrap gap-2 items-center">
              <button class="btn btn-primary" id="submitBtn" type="submit">Th√™m m·ªõi</button>
              <button class="btn btn-muted" type="button" onclick="document.forms.slotForm.reset();editingId=null;document.getElementById('submitBtn').textContent='Th√™m m·ªõi'">L√†m m·ªõi</button>
              <div class="flex-1"></div>
              <div class="flex items-center gap-2">
                <label class="sr-only" for="closeDay">ƒê√≥ng ng√†y</label>
                <select id="closeDay" class="field w-auto">
                  <option value="" selected>ƒê√≥ng ng√†y (ch·ªçn th·ª©)</option>
                  <option value="1">Th·ª© 2</option>
                  <option value="2">Th·ª© 3</option>
                  <option value="3">Th·ª© 4</option>
                  <option value="4">Th·ª© 5</option>
                  <option value="5">Th·ª© 6</option>
                  <option value="6">Th·ª© 7</option>
                  <option value="0">Ch·ªß nh·∫≠t</option>
                </select>
                <input id="closeReason" class="field w-52" placeholder="L√Ω do ngh·ªâ (v√≠ d·ª•: Ngh·ªâ l·ªÖ)" />
                <button type="button" class="btn btn-danger" onclick="quickCloseDay()">ƒê√≥ng ng√†y</button>
              </div>
            </div>
          </form>
        </div>

        <!-- Controls -->
        <div class="glass card p-4 space-y-3">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div>
              <div class="text-sm text-slate-400">Tu·∫ßn l√†m vi·ªác</div>
              <div class="flex items-center gap-2 mt-1">
                <label class="sr-only" for="weekSelect">Ch·ªçn tu·∫ßn</label>
                <select id="weekSelect" class="field w-auto"></select>
                <span class="text-xs text-slate-400">T·ªïng slot: <span id="count">0</span></span>
              </div>
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <button class="btn btn-danger" onclick="deleteAllSlots(false)">Xo√° t·∫•t c·∫£ l·ªãch</button>
              <button class="btn btn-success" onclick="applyDefaults()">√Åp d·ª•ng l·ªãch m·∫∑c ƒë·ªãnh</button>
            </div>
          </div>

          <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-2 mt-2">
            <label class="flex items-center gap-2"><input id="toggleClose_1" type="checkbox" onchange="onToggleClosed(1,this)" class="accent-rose-500"> T2</label>
            <label class="flex items-center gap-2"><input id="toggleClose_2" type="checkbox" onchange="onToggleClosed(2,this)" class="accent-rose-500"> T3</label>
            <label class="flex items-center gap-2"><input id="toggleClose_3" type="checkbox" onchange="onToggleClosed(3,this)" class="accent-rose-500"> T4</label>
            <label class="flex items-center gap-2"><input id="toggleClose_4" type="checkbox" onchange="onToggleClosed(4,this)" class="accent-rose-500"> T5</label>
            <label class="flex items-center gap-2"><input id="toggleClose_5" type="checkbox" onchange="onToggleClosed(5,this)" class="accent-rose-500"> T6</label>
            <label class="flex items-center gap-2"><input id="toggleClose_6" type="checkbox" onchange="onToggleClosed(6,this)" class="accent-rose-500"> T7</label>
            <label class="flex items-center gap-2"><input id="toggleClose_0" type="checkbox" onchange="onToggleClosed(0,this)" class="accent-rose-500"> CN</label>
          </div>
          <p class="text-xs text-slate-400">B·∫≠t c√¥ng t·∫Øc ƒë·ªÉ t·∫°o slot ƒê√≥ng c·ª≠a (00:00‚Äì23:59). T·∫Øt ƒë·ªÉ m·ªü l·∫°i ng√†y ƒë√≥.</p>
        </div>
      </div>

      <!-- TABLE -->
      <div class="glass card overflow-hidden">
        <div class="table-wrap overflow-auto">
          <table class="text-sm">
            <thead class="text-slate-200">
              <tr>
                <th class="text-left">ID</th>
                <th class="text-left">Th·ª©</th>
                <th class="text-left">Gi·ªù</th>
                <th class="text-left">TT</th>
                <th class="text-left">Ghi ch√∫</th>
                <th class="text-left">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- API ----------
    const weekdays = ['CN','T2','T3','T4','T5','T6','T7'];
    const api = {
      login: async (email,password)=>{
        const r = await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
        if(!r.ok) throw new Error('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
        return r.json();
      },
      list: async (weekStart) => {
        const r = await fetch('/api/schedule' + (weekStart?`?week=${weekStart}`:''));
        if (!r.ok) throw new Error('API /api/schedule l·ªói: ' + r.status);
        return r.json();
      },
      create: async (token,payload)=>{
        const r = await fetch('/api/admin/slots',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(payload)});
        if(!r.ok) throw new Error('T·∫°o th·∫•t b·∫°i');
        return r.json();
      },
      update: async (token,id,payload)=>{
        const r = await fetch('/api/admin/slots/'+id,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(payload)});
        if(!r.ok) throw new Error('C·∫≠p nh·∫≠t th·∫•t b·∫°i');
        return r.json();
      },
      remove: async (token,id)=>{
        const r = await fetch('/api/admin/slots/'+id,{method:'DELETE',headers:{'Authorization':'Bearer '+token}});
        if(!r.ok) throw new Error('Xo√° th·∫•t b·∫°i');
        return r.json();
      }
    }

    // ---------- State ----------
    let token = localStorage.getItem('ty_token')||'';
    let editingId = null;
    let cachedData = [];
    const DEFAULT_DOCTOR = 'Ths BSNT Phan Th·ªã Minh √ù';
    const DEFAULT_ROOM = 'PK SPK Th√†nh √ù';
    const DEFAULT_CAPACITY = 10;

    function isClosedAllDay(day){
      return cachedData.some(s=>s.weekday===day && s.status==='CLOSED' && s.start==='00:00' && s.end==='23:59');
    }

    function toast(msg,type='info'){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.className = 'toast px-4 py-3 rounded-lg text-white shadow-lg ' + (type==='error'?'bg-rose-500':'bg-emerald-600');
      el.style.display='block';
      setTimeout(()=>{ el.style.display='none' }, 2200);
    }

    async function refresh(){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      // skeleton rows
      for(let i=0;i<4;i++){
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" class="py-6 text-center text-slate-400 animate-pulse">ƒêang t·∫£i‚Ä¶</td>';
        tbody.appendChild(tr);
      }

      const data = await api.list(selectedWeekStart);
      cachedData = data;
      tbody.innerHTML = '';

      data.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="whitespace-nowrap text-slate-300">${s.id}</td>
          <td class="whitespace-nowrap">${weekdays[s.weekday]}</td>
          <td class="whitespace-nowrap">${s.start} - ${s.end}</td>
          <td class="whitespace-nowrap">${s.status==='CLOSED' ? '<span class="chip chip-closed">ƒê√≥ng</span>' : '<span class="chip chip-open">M·ªü</span>'}</td>
          <td class="text-slate-300">${s.note||''}</td>
          <td class="whitespace-nowrap">
            <div class="flex flex-wrap gap-2">
              <button class="btn btn-primary" onclick="onEdit(${s.id})" aria-label="S·ª≠a">‚úèÔ∏è<span class="hidden sm:inline">S·ª≠a</span></button>
              <button class="btn btn-muted" onclick="onDelete(${s.id})" aria-label="Xo√°">üóëÔ∏è<span class="hidden sm:inline">Xo√°</span></button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      })

      for(let d=0; d<7; d++){
        const cb = document.getElementById('toggleClose_'+d);
        if(cb) cb.checked = isClosedAllDay(d);
      }
      document.getElementById('count').textContent = data.length;
    }

    // ---------- Week helpers ----------
    let selectedWeekStart = '';
    const toISODate = (d)=>{ const d2 = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); return d2.toISOString().slice(0,10) };
    const getMonday = (d)=>{ const t = new Date(d); const day = t.getDay(); const diff = (day===0 ? -6 : 1 - day); t.setDate(t.getDate()+diff); t.setHours(0,0,0,0); return t };
    const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x };
    function isoWeekNumber(d){ const date=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const dayNum=(date.getUTCDay()+6)%7; date.setUTCDate(date.getUTCDate()-dayNum+3); const firstThursday=new Date(Date.UTC(date.getUTCFullYear(),0,4)); return 1+Math.round(((date-firstThursday)/86400000-3)/7) }
    function labelForWeek(monday){ const week=isoWeekNumber(monday); const start=monday; const end=addDays(monday,6); const fmt=(d)=> String(d.getDate()).padStart(2,'0')+'.'+String(d.getMonth()+1).padStart(2,'0'); return `W${String(week).padStart(2,'0')} ${fmt(start)} - ${fmt(end)}` }
    function getWeekCandidates(){ const today=new Date(); const m0=getMonday(today); return [0,1,2,3].map(i=>{ const m=addDays(m0,i*7); return { iso: toISODate(m), label: labelForWeek(m) } }) }

    function formToPayload(){
      const f = document.forms.slotForm;
      return {
        weekday: parseInt(f.weekday.value,10),
        start: f.start.value,
        end: f.end.value,
        doctor: DEFAULT_DOCTOR,
        room: DEFAULT_ROOM,
        note: f.note.value.trim(),
        status: f.status.value,
        capacity: DEFAULT_CAPACITY,
        weekStart: selectedWeekStart
      };
    }

    async function onSubmit(e){
      e.preventDefault();
      try{
        const payload = formToPayload();
        const conflicts = findConflicts(payload.weekday, payload.start, payload.end, editingId);
        if(conflicts.length){
          const list = conflicts.map(s=>`#${s.id} ${s.start}-${s.end} ${s.status==='CLOSED'?'ƒê√≥ng':'M·ªü'}`).join('\n');
          alert('Khung gi·ªù b·∫°n nh·∫≠p b·ªã giao thoa v·ªõi:\n' + list + '\nVui l√≤ng s·ª≠a ho·∫∑c xo√° tr∆∞·ªõc.');
          return;
        }
        if(editingId){ await api.update(token, editingId, payload); toast('ƒê√£ c·∫≠p nh·∫≠t khung gi·ªù') }
        else { await api.create(token, payload); toast('ƒê√£ th√™m khung gi·ªù m·ªõi') }
        document.forms.slotForm.reset();
        editingId = null;
        document.getElementById('submitBtn').textContent = 'Th√™m m·ªõi';
        await refresh();
      }catch(err){ toast(err.message,'error') }
    }

    async function onLogin(e){
      e.preventDefault();
      try{
        const f = document.forms.loginForm;
        const { token: t } = await api.login(f.email.value.trim(), f.password.value);
        token = t; localStorage.setItem('ty_token', t);
        document.getElementById('auth').classList.add('hidden');
        document.getElementById('panel').classList.remove('hidden');
        initWeekSelect();
        await refresh();
        toast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng');
      }catch(err){ alert(err.message) }
    }

    function onEdit(id){
      const tr = [...document.querySelectorAll('#tbody tr')].find(r=>r.firstElementChild.textContent==id);
      if(!tr) return;
      const f = document.forms.slotForm;
      const tds = tr.children;
      editingId = id;
      f.weekday.value = ['CN','T2','T3','T4','T5','T6','T7'].indexOf(tds[1].textContent);
      const [start,end] = tds[2].textContent.split(' - ');
      f.start.value=start; f.end.value=end;
      f.status.value = tds[3].textContent.includes('ƒê√≥ng')?'CLOSED':'AVAILABLE';
      f.note.value = tds[4].textContent;
      document.getElementById('submitBtn').textContent = 'C·∫≠p nh·∫≠t';
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function initWeekSelect(){
      const sel = document.getElementById('weekSelect');
      const items = getWeekCandidates();
      sel.innerHTML = '';
      items.forEach((w,i)=>{
        const opt = document.createElement('option');
        opt.value = w.iso; opt.textContent = (i===0 ? '(Tu·∫ßn n√†y) ' : '') + w.label; sel.appendChild(opt);
      });
      selectedWeekStart = items[0].iso;
      sel.value = selectedWeekStart;
      sel.addEventListener('change', async ()=>{ selectedWeekStart = sel.value; await refresh(); });
    }

    const toMin = (t)=>{ const [h,m]=t.split(':').map(Number); return h*60+m };
    const isOverlap = (aStart,aEnd,bStart,bEnd)=> Math.min(toMin(aEnd), toMin(bEnd)) > Math.max(toMin(aStart), toMin(bStart));
    function findConflicts(weekday, start, end, exceptId=null){
      return cachedData.filter(s => s.weekday===weekday && s.id!==exceptId && isOverlap(s.start, s.end, start, end));
    }

    async function onDelete(id){
      if(!confirm('Xo√° khung gi·ªù #' + id + ' ?')) return;
      try{ await api.remove(token, id); await refresh(); toast('ƒê√£ xo√° khung gi·ªù') }catch(err){ toast(err.message,'error') }
    }

    function logout(){ localStorage.removeItem('ty_token'); location.reload(); }

    async function quickCloseDay(){
      const dayStr = document.getElementById('closeDay').value;
      if(dayStr===''){ alert('Ch·ªçn th·ª© c·∫ßn ƒë√≥ng'); return }
      const day = parseInt(dayStr,10);
      const reason = document.getElementById('closeReason').value.trim() || 'Ngh·ªâ';

      try{
        const existsAll = cachedData.filter(s=>s.weekday===day);
        for(const s of existsAll){ await api.remove(token, s.id) }
        await api.create(token,{ weekday: day, start: '00:00', end: '23:59', doctor: '-', room: '-', note: reason, status: 'CLOSED', capacity: 0, weekStart: selectedWeekStart });
        document.getElementById('closeDay').value='';
        document.getElementById('closeReason').value='';
        await refresh();
        toast('ƒê√£ ƒë√≥ng c·∫£ ng√†y');
      }catch(err){ toast(err.message,'error') }
    }

    async function applyDefaults(){
      const sundayNote = 'CN c√≥ Test ti·ªÉu ƒë∆∞·ªùng thai k√¨, c√°c B·∫ßu l∆∞u √Ω ph·∫£i nh·ªãn ƒÉn tr∆∞·ªõc ƒë√≥ 8 ti·∫øng.';
      const doctor = DEFAULT_DOCTOR; const room = DEFAULT_ROOM;
      const plan = [];
      plan.push({weekday:0,start:'07:00',end:'11:00',doctor,room,note:sundayNote,status:'AVAILABLE',capacity:10, weekStart: selectedWeekStart});
      for(let d=1; d<=6; d++) plan.push({weekday:d,start:'17:00',end:'20:00',doctor,room,note:'',status:'AVAILABLE',capacity:10, weekStart: selectedWeekStart});

      const logs = []; let created = 0;
      try{
        for(const p of plan){
          const exactDup = cachedData.some(s=> s.weekday===p.weekday && s.start===p.start && s.end===p.end && s.status===p.status);
          if(exactDup){ logs.push(`B·ªè qua do ƒë√£ t·ªìn t·∫°i: Th·ª© ${p.weekday} ${p.start}-${p.end}`); continue }
          let conflicts = findConflicts(p.weekday, p.start, p.end);
          const closedAllDay = conflicts.filter(s=>s.status==='CLOSED' && s.start==='00:00' && s.end==='23:59');
          if(closedAllDay.length){ for(const s of closedAllDay){ await api.remove(token, s.id) } cachedData = await api.list(selectedWeekStart); conflicts = findConflicts(p.weekday, p.start, p.end); }
          if(conflicts.length){ const list = conflicts.map(s=>`#${s.id} ${s.start}-${s.end} ${s.status==='CLOSED'?'ƒê√≥ng':'M·ªü'}`).join(', '); logs.push(`Kh√¥ng th·ªÉ t·∫°o Th·ª© ${p.weekday} ${p.start}-${p.end} v√¨ giao thoa v·ªõi: ${list}`); continue }
          await api.create(token, p); created++; cachedData = await api.list(selectedWeekStart);
        }
        await refresh();
        alert(`√Åp d·ª•ng l·ªãch m·∫∑c ƒë·ªãnh: t·∫°o m·ªõi ${created} slot.\n` + (logs.length ? ('Ghi ch√∫:\n- ' + logs.join('\n- ')) : ''));
      }catch(err){ alert(err.message) }
    }

    async function deleteAllSlots(reseed){
      if(!token){ alert('Vui l√≤ng ƒëƒÉng nh·∫≠p'); return }
      if(!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën XO√Å T·∫§T C·∫¢ l·ªãch? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) return;
      const confirmWord = prompt('G√µ "XOA" ƒë·ªÉ x√°c nh·∫≠n:');
      if((confirmWord || '').toUpperCase() !== 'XOA'){ alert('Hu·ª∑ thao t√°c.'); return }
      try{
        const url = '/api/admin/slots/purge' + (reseed ? '?defaults=1' : '');
        const r = await fetch(url, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
        if(!r.ok){ const t = await r.json().catch(()=>({})); throw new Error(t.error || 'Xo√° t·∫•t c·∫£ th·∫•t b·∫°i') }
        const res = await r.json();
        alert(`ƒê√£ xo√° ${res.deleted || 0} slot.` + (res.reseeded ? '\nƒê√£ t·∫°o l·∫°i l·ªãch m·∫∑c ƒë·ªãnh.' : ''));
        await refresh();
      }catch(err){ alert(err.message) }
    }

    async function onToggleClosed(day, el){
      try{
        if(el.checked){
          const targetsAll = cachedData.filter(s=>s.weekday===day);
          for(const s of targetsAll){ await api.remove(token, s.id) }
          await api.create(token,{ weekday:day,start:'00:00',end:'23:59', doctor:'-',room:'-',note:'ƒê√≥ng c·ª≠a',status:'CLOSED',capacity:0, weekStart: selectedWeekStart });
        }else{
          const targets = cachedData.filter(s=>s.weekday===day && s.status==='CLOSED' && s.start==='00:00' && s.end==='23:59');
          for(const s of targets){ await api.remove(token, s.id) }
        }
        await refresh();
      }catch(err){ alert(err.message); el.checked = !el.checked }
    }

    // Init auth view
    (function init(){
      if(token){ document.getElementById('panel').classList.remove('hidden'); initWeekSelect(); refresh(); }
      else { document.getElementById('auth').classList.remove('hidden'); }
    })();
  </script>
</body>
</html>