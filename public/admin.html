<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Phòng Khám Thành Ý</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass{background:rgba(17,24,39,0.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);}
  </style>
  <script>
    // Map theo index DB: 0=CN,1=T2,...6=T7
    const weekdays = ['CN','T2','T3','T4','T5','T6','T7'];
    const api = {
      login: async (email,password)=>{
        const r = await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
        if(!r.ok) throw new Error('Đăng nhập thất bại');
        return r.json();
      },
      list: async ()=> (await fetch('/api/schedule')).json(),
      create: async (token,payload)=>{
        const r = await fetch('/api/admin/slots',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(payload)});
        if(!r.ok) throw new Error('Tạo thất bại');
        return r.json();
      },
      update: async (token,id,payload)=>{
        const r = await fetch('/api/admin/slots/'+id,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(payload)});
        if(!r.ok) throw new Error('Cập nhật thất bại');
        return r.json();
      },
      remove: async (token,id)=>{
        const r = await fetch('/api/admin/slots/'+id,{method:'DELETE',headers:{'Authorization':'Bearer '+token}});
        if(!r.ok) throw new Error('Xoá thất bại');
        return r.json();
      }
    }

    let token = localStorage.getItem('ty_token')||'';
    let editingId = null;
    let cachedData = [];
    const DEFAULT_DOCTOR = 'Ths BSNT Phan Thị Minh Ý';
    const DEFAULT_ROOM = 'PK SPK Thành Ý';
    const DEFAULT_CAPACITY = 10;

    function isClosedAllDay(day){
      return cachedData.some(s=>s.weekday===day && s.status==='CLOSED' && s.start==='00:00' && s.end==='23:59');
    }

    async function refresh(){
      const data = await api.list();
      cachedData = data;
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      data.forEach(s=>{
        const tr = document.createElement('tr');
        tr.className = 'divide-x divide-white/10';
        tr.innerHTML = `
          <td class="p-3">${s.id}</td>
          <td class="p-3">${weekdays[s.weekday]}</td>
          <td class="p-3">${s.start} - ${s.end}</td>
          <td class="p-3">${s.doctor}</td>
          <td class="p-3">${s.room}</td>
          <td class="p-3">${s.capacity}</td>
          <td class="p-3">${s.status==='CLOSED'?'Đóng':'Mở'}</td>
          <td class="p-3">${s.note||''}</td>
          <td class="p-3">
            <div class="flex gap-2">
              <button class="px-3 py-1 rounded bg-cyan-600 hover:bg-cyan-500 text-white" onclick="onEdit(${s.id})">Sửa</button>
              <button class="px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 text-white" onclick="onDelete(${s.id})">Xoá</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      })
      for(let d=0; d<7; d++){
        const cb = document.getElementById('toggleClose_'+d);
        if(cb) cb.checked = isClosedAllDay(d);
      }
    }

    function formToPayload(){
      const f = document.forms.slotForm;
      return {
        weekday: parseInt(f.weekday.value,10),
        start: f.start.value,
        end: f.end.value,
        doctor: DEFAULT_DOCTOR,
        room: DEFAULT_ROOM,
        note: f.note.value.trim(),
        status: f.status.value,
        capacity: DEFAULT_CAPACITY
      };
    }

    async function onSubmit(e){
      e.preventDefault();
      try{
        const payload = formToPayload();
        if(editingId){
          await api.update(token, editingId, payload);
        }else{
          await api.create(token, payload);
        }
        document.forms.slotForm.reset();
        editingId = null;
        document.getElementById('submitBtn').textContent = 'Thêm mới';
        await refresh();
      }catch(err){ alert(err.message) }
    }

    async function onLogin(e){
      e.preventDefault();
      try{
        const f = document.forms.loginForm;
        const { token: t } = await api.login(f.email.value.trim(), f.password.value);
        token = t; localStorage.setItem('ty_token', t);
        document.getElementById('auth').style.display='none';
        document.getElementById('panel').style.display='block';
        await refresh();
      }catch(err){ alert(err.message) }
    }

    function onEdit(id){
      const tr = [...document.querySelectorAll('#tbody tr')].find(r=>r.firstElementChild.textContent==id);
      if(!tr) return;
      const f = document.forms.slotForm;
      const tds = tr.children;
      editingId = id;
      f.weekday.value = ['CN','T2','T3','T4','T5','T6','T7'].indexOf(tds[1].textContent);
      const [start,end] = tds[2].textContent.split(' - ');
      f.start.value=start; f.end.value=end;
      // doctor/room/capacity are defaulted; only map status and note
      f.status.value = tds[3].textContent==='Đóng'?'CLOSED':'AVAILABLE';
      f.note.value = tds[4].textContent;
      document.getElementById('submitBtn').textContent = 'Cập nhật';
      window.scrollTo({top:0,behavior:'smooth'});
    }

    async function onDelete(id){
      if(!confirm('Xoá khung giờ #' + id + ' ?')) return;
      try{ await api.remove(token, id); await refresh(); }catch(err){ alert(err.message) }
    }

    function logout(){ localStorage.removeItem('ty_token'); location.reload(); }
    async function quickCloseDay(){
      const day = document.getElementById('closeDay').value;
      if(day===''){ alert('Chọn thứ cần đóng'); return }
      const reason = document.getElementById('closeReason').value.trim() || 'Nghỉ';
      try{
        await api.create(token, { weekday: parseInt(day,10), start: '00:00', end: '23:59', doctor: '-', room: '-', note: reason, status: 'CLOSED', capacity: 0 });
        document.getElementById('closeDay').value='';
        document.getElementById('closeReason').value='';
        await refresh();
      }catch(err){ alert(err.message) }
    }

    async function applyDefaults(){
      const sundayNote = 'CN có Test tiểu đường thai kì, các Bầu lưu ý phải nhịn ăn trước đó 10 tiếng.';
      const doctor = 'Ths BSNT Phan Thị Minh Ý';
      const room = 'PK SPK Thành Ý';
      const calls = [];
      // CN (0): 07:00-11:00 với ghi chú đặc biệt
      calls.push(api.create(token,{weekday:0,start:'07:00',end:'11:00',doctor,room,note:sundayNote,status:'AVAILABLE',capacity:10}));
      // T2-T7 (1-6): 17:00-20:00
      for(let d=1; d<=6; d++){
        calls.push(api.create(token,{weekday:d,start:'17:00',end:'20:00',doctor,room,note:'',status:'AVAILABLE',capacity:10}));
      }
      try{ await Promise.all(calls); await refresh(); alert('Đã áp dụng lịch mặc định.'); }catch(err){ alert(err.message) }
    }

    async function onToggleClosed(day, el){
      try{
        if(el.checked){
          await api.create(token,{weekday:day,start:'00:00',end:'23:59',doctor:'-',room:'-',note:'Đóng cửa',status:'CLOSED',capacity:0});
        }else{
          const targets = cachedData.filter(s=>s.weekday===day && s.status==='CLOSED' && s.start==='00:00' && s.end==='23:59');
          for(const s of targets){ await api.remove(token, s.id); }
        }
        await refresh();
      }catch(err){ alert(err.message); el.checked = !el.checked; }
    }
  </script>
</head>
<body class="bg-slate-900">
  <header class="sticky top-0 z-10 bg-gradient-to-r from-slate-900 to-slate-800 text-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-lg font-semibold">Admin — Phòng Khám Thành Ý</h1>
      <a href="/" class="text-white/80 hover:text-white text-sm">Trang chủ</a>
    </div>
  </header>
  <div class="relative min-h-screen bg-gradient-to-br from-slate-900 to-slate-800">
    <div class="absolute inset-0 opacity-40 bg-[radial-gradient(circle_at_20%_20%,rgba(56,189,248,0.35),transparent_40%),radial-gradient(circle_at_80%_0%,rgba(99,102,241,0.35),transparent_35%)]"></div>
    <div class="relative max-w-6xl mx-auto px-4 py-6">
    <div id="auth" class="glass border border-white/10 rounded-xl p-4 mb-4" style="display:none">
      <form name="loginForm" onsubmit="onLogin(event)">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-slate-300 text-sm mb-1">Email</label>
            <input class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="email" type="email" placeholder="admin@thanhy.vn" required />
          </div>
          <div>
            <label class="block text-slate-300 text-sm mb-1">Mật khẩu</label>
            <input class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="password" type="password" placeholder="admin123" required />
          </div>
          <div class="flex items-end">
            <button class="w-full px-4 py-2 rounded-lg bg-cyan-500 hover:bg-cyan-400 text-white font-medium" type="submit">Đăng nhập</button>
          </div>
        </div>
      </form>
    </div>

    <div id="panel" style="display:none">
      <div class="glass border border-white/10 rounded-xl p-4 mb-4">
        <form name="slotForm" onsubmit="onSubmit(event)">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="block text-slate-300 text-sm mb-1">Thứ</label>
              <select class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="weekday">
                <option value="1">Thứ 2</option>
                <option value="2">Thứ 3</option>
                <option value="3">Thứ 4</option>
                <option value="4">Thứ 5</option>
                <option value="5">Thứ 6</option>
                <option value="6">Thứ 7</option>
                <option value="0">Chủ nhật</option>
              </select>
            </div>
            <div>
              <label class="block text-slate-300 text-sm mb-1">Giờ bắt đầu</label>
              <input class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="start" type="time" required />
            </div>
            <div>
              <label class="block text-slate-300 text-sm mb-1">Giờ kết thúc</label>
              <input class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="end" type="time" required />
            </div>
            <div>
              <label class="block text-slate-300 text-sm mb-1">Trạng thái</label>
              <select class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="status">
                <option value="AVAILABLE">Mở</option>
                <option value="CLOSED">Đóng</option>
              </select>
            </div>
            <div>
              <label class="block text-slate-300 text-sm mb-1">Ghi chú</label>
              <textarea class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="note" placeholder="Ghi chú thêm (nếu có)"></textarea>
            </div>
          </div>
          <div class="mt-3 flex flex-wrap gap-2 items-center">
            <button class="px-4 py-2 rounded-lg bg-cyan-500 hover:bg-cyan-400 text-white font-medium" id="submitBtn" type="submit">Thêm mới</button>
            <button class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white" type="button" onclick="document.forms.slotForm.reset();editingId=null;document.getElementById('submitBtn').textContent='Thêm mới'">Làm mới</button>
            <button class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white" type="button" onclick="logout()">Đăng xuất</button>
            <div class="flex-1"></div>
            <div class="flex items-center gap-2">
              <select id="closeDay" class="px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white">
                <option value="" selected>Đóng ngày (chọn thứ)</option>
                <option value="1">Thứ 2</option>
                <option value="2">Thứ 3</option>
                <option value="3">Thứ 4</option>
                <option value="4">Thứ 5</option>
                <option value="5">Thứ 6</option>
                <option value="6">Thứ 7</option>
                <option value="0">Chủ nhật</option>
              </select>
              <input id="closeReason" class="px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" placeholder="Lý do nghỉ (ví dụ: Nghỉ lễ)" />
              <button type="button" class="px-4 py-2 rounded-lg bg-rose-500 hover:bg-rose-400 text-white" onclick="quickCloseDay()">Đóng ngày</button>
            </div>
          </div>
        </form>
      </div>

      <div class="glass border border-white/10 rounded-xl overflow-hidden">
        <div class="flex flex-col gap-3 p-4">
          <div class="flex items-center justify-between">
            <div class="text-slate-200 font-medium">Đóng cửa theo ngày</div>
            <button class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white" onclick="applyDefaults()">Áp dụng lịch mặc định</button>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_1" type="checkbox" onchange="onToggleClosed(1,this)" class="accent-rose-500"> T2</label>
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_2" type="checkbox" onchange="onToggleClosed(2,this)" class="accent-rose-500"> T3</label>
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_3" type="checkbox" onchange="onToggleClosed(3,this)" class="accent-rose-500"> T4</label>
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_4" type="checkbox" onchange="onToggleClosed(4,this)" class="accent-rose-500"> T5</label>
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_5" type="checkbox" onchange="onToggleClosed(5,this)" class="accent-rose-500"> T6</label>
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_6" type="checkbox" onchange="onToggleClosed(6,this)" class="accent-rose-500"> T7</label>
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_0" type="checkbox" onchange="onToggleClosed(0,this)" class="accent-rose-500"> CN</label>
          </div>
          <div class="text-xs text-slate-400">Bật công tắc để tạo slot Đóng cửa (00:00–23:59). Tắt để mở lại ngày đó.</div>
        </div>
        <table class="w-full text-sm">
          <thead class="bg-white/10 text-slate-200">
            <tr>
              <th class="p-3 text-left">ID</th>
              <th class="p-3 text-left">Thứ</th>
              <th class="p-3 text-left">Giờ</th>
              <th class="p-3 text-left">Bác sĩ</th>
              <th class="p-3 text-left">Phòng</th>
              <th class="p-3 text-left">Số BN</th>
              <th class="p-3 text-left">TT</th>
              <th class="p-3 text-left">Ghi chú</th>
              <th class="p-3 text-left">Hành động</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-white/10 text-slate-100"></tbody>
        </table>
      </div>
    </div>
    </div>
  </div>

  <script>
    // Init auth view
    if(token){ document.getElementById('panel').style.display='block'; refresh(); }
    else { document.getElementById('auth').style.display='block'; }
  </script>
</body>
</html>


