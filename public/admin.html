<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Phòng Khám Thành Ý</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass{background:rgba(17,24,39,0.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);}
  </style>
  <script>
    // Map theo index DB: 0=CN,1=T2,...6=T7
    const weekdays = ['CN','T2','T3','T4','T5','T6','T7'];
    const api = {
      login: async (email,password)=>{
        const r = await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
        if(!r.ok) throw new Error('Đăng nhập thất bại');
        return r.json();
      },
	  list: async (weekStart) => {
		  const r = await fetch('/api/schedule' + (weekStart?`?week=${weekStart}`:''));
		  if (!r.ok) throw new Error('API /api/schedule lỗi: ' + r.status);
		  return r.json();
		},

      create: async (token,payload)=>{
        const r = await fetch('/api/admin/slots',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(payload)});
        if(!r.ok) throw new Error('Tạo thất bại');
        return r.json();
      },
      update: async (token,id,payload)=>{
        const r = await fetch('/api/admin/slots/'+id,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(payload)});
        if(!r.ok) throw new Error('Cập nhật thất bại');
        return r.json();
      },
      remove: async (token,id)=>{
        const r = await fetch('/api/admin/slots/'+id,{method:'DELETE',headers:{'Authorization':'Bearer '+token}});
        if(!r.ok) throw new Error('Xoá thất bại');
        return r.json();
      }
    }

    let token = localStorage.getItem('ty_token')||'';
    let editingId = null;
    let cachedData = [];
    const DEFAULT_DOCTOR = 'Ths BSNT Phan Thị Minh Ý';
    const DEFAULT_ROOM = 'PK SPK Thành Ý';
    const DEFAULT_CAPACITY = 10;

    function isClosedAllDay(day){
      return cachedData.some(s=>s.weekday===day && s.status==='CLOSED' && s.start==='00:00' && s.end==='23:59');
    }

    async function refresh(){
      const data = await api.list(selectedWeekStart);
      cachedData = data;
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      data.forEach(s=>{
        const tr = document.createElement('tr');
        tr.className = 'divide-x divide-white/10';
        tr.innerHTML = `
          <td class="px-3 py-2">${s.id}</td>
          <td class="px-3 py-2">${weekdays[s.weekday]}</td>
          <td class="px-3 py-2">${s.start} - ${s.end}</td>
          <td class="px-3 py-2">${s.status==='CLOSED'?'Đóng':'Mở'}</td>
          <td class="px-3 py-2">${s.note||''}</td>
          <td class="px-3 py-2">
            <div class="flex flex-wrap gap-2">
              <button class="px-3 py-1 rounded bg-cyan-600 hover:bg-cyan-500 text-white" onclick="onEdit(${s.id})">Sửa</button>
              <button class="px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 text-white" onclick="onDelete(${s.id})">Xoá</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      })
      for(let d=0; d<7; d++){
        const cb = document.getElementById('toggleClose_'+d);
        if(cb) cb.checked = isClosedAllDay(d);
      }
    }

	let selectedWeekStart = ''; // 'YYYY-MM-DD' thứ Hai tuần đang chọn (mặc định = tuần này)

	function toISODate(d){ // YYYY-MM-DD (UTC)
	  const d2 = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
	  return d2.toISOString().slice(0,10);
	}
	function getMonday(d){ // Monday of week (local)
	  const t = new Date(d);
	  const day = t.getDay(); // 0=Sun..6=Sat
	  const diff = (day === 0 ? -6 : 1 - day); // move to Monday
	  t.setDate(t.getDate() + diff);
	  t.setHours(0,0,0,0);
	  return t;
	}
	function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
	function isoWeekNumber(d){ // ISO week (Mon first)
	  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
	  const dayNum = (date.getUTCDay() + 6) % 7; // 0..6 Mon..Sun
	  date.setUTCDate(date.getUTCDate() - dayNum + 3);
	  const firstThursday = new Date(Date.UTC(date.getUTCFullYear(),0,4));
	  const week = 1 + Math.round(((date - firstThursday) / 86400000 - 3) / 7);
	  return week;
	}
	function labelForWeek(monday){ // monday is Date (local)
	  const week = isoWeekNumber(monday);
	  const start = monday;
	  const end = addDays(monday, 6);
	  const fmt = (d)=> String(d.getDate()).padStart(2,'0') + '.' + String(d.getMonth()+1).padStart(2,'0');
	  return `W${String(week).padStart(2,'0')} ${fmt(start)} - ${fmt(end)}`;
	}
	function getWeekCandidates(){ // current + next 3
	  const today = new Date();
	  const m0 = getMonday(today);
	  return [0,1,2,3].map(i=>{
		const m = addDays(m0, i*7);
		return { iso: toISODate(m), label: labelForWeek(m) };
	  });
	}

    function formToPayload(){
	  const f = document.forms.slotForm;
	  return {
		weekday: parseInt(f.weekday.value,10),
		start: f.start.value,
		end: f.end.value,
		doctor: DEFAULT_DOCTOR,
		room: DEFAULT_ROOM,
		note: f.note.value.trim(),
		status: f.status.value,
		capacity: DEFAULT_CAPACITY,
		weekStart: selectedWeekStart // <-- NEW
	  };
	}


    async function onSubmit(e){
	  e.preventDefault();
	  try{
		const payload = formToPayload();

		// 1) Không cho phép giao thoa khi người dùng nhập tay
		const conflicts = findConflicts(payload.weekday, payload.start, payload.end, editingId);
		if(conflicts.length){
		  const list = conflicts.map(s=>`#${s.id} ${s.start}-${s.end} ${s.status==='CLOSED'?'Đóng':'Mở'}`).join('\n');
		  alert('Khung giờ bạn nhập bị giao thoa với:\n' + list + '\nVui lòng sửa hoặc xoá trước.');
		  return;
		}

		// 2) Tạo/cập nhật
		if(editingId){
		  await api.update(token, editingId, payload);
		}else{
		  await api.create(token, payload);
		}
		document.forms.slotForm.reset();
		editingId = null;
		document.getElementById('submitBtn').textContent = 'Thêm mới';
		await refresh();
	  }catch(err){ alert(err.message) }
	}

    async function onLogin(e){
	  e.preventDefault();
	  try{
		const f = document.forms.loginForm;
		const { token: t } = await api.login(f.email.value.trim(), f.password.value);
		token = t; localStorage.setItem('ty_token', t);
		document.getElementById('auth').style.display='none';
		document.getElementById('panel').style.display='block';
		initWeekSelect();            // <-- THÊM DÒNG NÀY
		await refresh();
	  }catch(err){ alert(err.message) }
	}


    function onEdit(id){
      const tr = [...document.querySelectorAll('#tbody tr')].find(r=>r.firstElementChild.textContent==id);
      if(!tr) return;
      const f = document.forms.slotForm;
      const tds = tr.children;
      editingId = id;
      f.weekday.value = ['CN','T2','T3','T4','T5','T6','T7'].indexOf(tds[1].textContent);
      const [start,end] = tds[2].textContent.split(' - ');
      f.start.value=start; f.end.value=end;
      // doctor/room/capacity are defaulted; only map status and note
      f.status.value = tds[3].textContent==='Đóng'?'CLOSED':'AVAILABLE';
      f.note.value = tds[4].textContent;
      document.getElementById('submitBtn').textContent = 'Cập nhật';
      window.scrollTo({top:0,behavior:'smooth'});
    }

	function initWeekSelect(){
	  const sel = document.getElementById('weekSelect');
	  const items = getWeekCandidates();
	  sel.innerHTML = '';
	  items.forEach((w,i)=>{
		const opt = document.createElement('option');
		opt.value = w.iso;
		opt.textContent = (i===0 ? '(Tuần này) ' : '') + w.label;
		sel.appendChild(opt);
	  });
	  selectedWeekStart = items[0].iso;
	  sel.value = selectedWeekStart;
	  sel.addEventListener('change', async ()=>{
		selectedWeekStart = sel.value;
		await refresh();
	  });
	}

	function toMin(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
	function isOverlap(aStart,aEnd,bStart,bEnd){
	  return Math.min(toMin(aEnd), toMin(bEnd)) > Math.max(toMin(aStart), toMin(bStart));
	}
	function findConflicts(weekday, start, end, exceptId=null){
	  return cachedData.filter(
		s => s.weekday===weekday && s.id!==exceptId && isOverlap(s.start, s.end, start, end)
	  );
	}
    async function onDelete(id){
      if(!confirm('Xoá khung giờ #' + id + ' ?')) return;
      try{ await api.remove(token, id); await refresh(); }catch(err){ alert(err.message) }
    }

    function logout(){ localStorage.removeItem('ty_token'); location.reload(); }
    async function quickCloseDay(){
	  const dayStr = document.getElementById('closeDay').value;
	  if(dayStr===''){ alert('Chọn thứ cần đóng'); return }
	  const day = parseInt(dayStr,10);
	  const reason = document.getElementById('closeReason').value.trim() || 'Nghỉ';

	  try{
		// Xoá toàn bộ slot của ngày trước khi tạo CLOSED all-day
		const existsAll = cachedData.filter(s=>s.weekday===day);
		for(const s of existsAll){ await api.remove(token, s.id); }

		await api.create(token,{
		  weekday: day, start: '00:00', end: '23:59',
		  doctor: '-', room: '-', note: reason, status: 'CLOSED', capacity: 0,
		  weekStart: selectedWeekStart    // <-- THÊM
		});

		document.getElementById('closeDay').value='';
		document.getElementById('closeReason').value='';
		await refresh();
	  }catch(err){ alert(err.message) }
	}

    async function applyDefaults(){
	  const sundayNote = 'CN có Test tiểu đường thai kì, các Bầu lưu ý phải nhịn ăn trước đó 8 tiếng.';
	  const doctor = 'Ths BSNT Phan Thị Minh Ý';
	  const room = 'PK SPK Thành Ý';

	  // Định nghĩa các slot mặc định sẽ cố gắng tạo
	  const plan = [];

	  // CN (0): 07:00-11:00
	  plan.push({weekday:0,start:'07:00',end:'11:00',doctor,room,note:sundayNote,status:'AVAILABLE',capacity:10,
             weekStart: selectedWeekStart}); // <--

	  // T2-T7 (1-6): 17:00-20:00
	  for(let d=1; d<=6; d++){
		plan.push({weekday:d,start:'17:00',end:'20:00',doctor,room,note:'',status:'AVAILABLE',capacity:10,
				   weekStart: selectedWeekStart}); // <--
	  }

	  const logs = [];
	  let created = 0;

	  try{
		for(const p of plan){
		  // 1) Nếu đã có slot y hệt (cùng weekday, start, end, status) → bỏ qua (tránh duplicate)
		  const exactDup = cachedData.some(
			s=> s.weekday===p.weekday && s.start===p.start && s.end===p.end && s.status===p.status
		  );
		  if(exactDup){
			logs.push(`Bỏ qua do đã tồn tại: Thứ ${p.weekday} ${p.start}-${p.end}`);
			continue;
		  }

		  // 2) Tìm các slot giao thoa
		  let conflicts = findConflicts(p.weekday, p.start, p.end);

		  // 2a) Nếu có CLOSED all-day → xoá trước (không bỏ qua all-day, mà xử lý dứt điểm)
		  const closedAllDay = conflicts.filter(s=>s.status==='CLOSED' && s.start==='00:00' && s.end==='23:59');
		  if(closedAllDay.length){
			for(const s of closedAllDay){ await api.remove(token, s.id); }
			// refresh dữ liệu cục bộ để bước sau chính xác
			const refreshed = await api.list(selectedWeekStart); // <--
			cachedData = refreshed;
			// tính lại conflicts sau khi xoá all-day
			conflicts = findConflicts(p.weekday, p.start, p.end);
		  }

		  // 2b) Nếu vẫn còn xung đột với slot khác (OPEN/CLOSED lẻ tẻ) → bỏ qua để không tạo giao thoa
		  if(conflicts.length){
			const list = conflicts.map(s=>`#${s.id} ${s.start}-${s.end} ${s.status==='CLOSED'?'Đóng':'Mở'}`).join(', ');
			logs.push(`Không thể tạo Thứ ${p.weekday} ${p.start}-${p.end} vì giao thoa với: ${list}`);
			continue;
		  }

		  // 3) Không còn xung đột → tạo
		  await api.create(token, p);
		  created++;
		  // cập nhật cache để vòng lặp tiếp theo dùng
		  const refreshed2 = await api.list(selectedWeekStart); // <--
		  cachedData = refreshed2;
		}

		await refresh();
		alert(`Áp dụng lịch mặc định: tạo mới ${created} slot.\n` + (logs.length ? ('Ghi chú:\n- ' + logs.join('\n- ')) : ''));
	  }catch(err){
		alert(err.message);
	  }
	}

	async function deleteAllSlots(reseed){
	  if(!token){ alert('Vui lòng đăng nhập'); return; }

	  // Xác nhận 2 bước cho an toàn
	  if(!confirm('Bạn chắc chắn muốn XOÁ TẤT CẢ lịch? Hành động này không thể hoàn tác.')) return;
	  const confirmWord = prompt('Gõ "XOA" để xác nhận:');
	  if((confirmWord || '').toUpperCase() !== 'XOA'){ alert('Huỷ thao tác.'); return; }

	  try{
		const url = '/api/admin/slots/purge' + (reseed ? '?defaults=1' : '');
		const r = await fetch(url, {
		  method: 'DELETE',
		  headers: { 'Authorization': 'Bearer ' + token }
		});
		if(!r.ok){
		  const t = await r.json().catch(()=>({}));
		  throw new Error(t.error || 'Xoá tất cả thất bại');
		}
		const res = await r.json();
		alert(`Đã xoá ${res.deleted || 0} slot.` + (res.reseeded ? '\nĐã tạo lại lịch mặc định.' : ''));
		await refresh();
	  }catch(err){
		alert(err.message);
	  }
	}

    async function onToggleClosed(day, el){
	  try{
		if(el.checked){
		  // 1) Xoá tất cả slot của ngày trước (cả OPEN/CLOSED lẻ tẻ) để tránh xung đột
		  const targetsAll = cachedData.filter(s=>s.weekday===day);
		  for(const s of targetsAll){ await api.remove(token, s.id); }

		  // 2) Tạo duy nhất một slot CLOSED 00:00–23:59
			await api.create(token,{
			  weekday:day,start:'00:00',end:'23:59',
			  doctor:'-',room:'-',note:'Đóng cửa',status:'CLOSED',capacity:0,
			  weekStart: selectedWeekStart    // <-- THÊM
			});

		}else{
		  // Bỏ đóng: xoá slot CLOSED 00:00–23:59, các slot khác không tự phục hồi
		  const targets = cachedData.filter(s=>s.weekday===day && s.status==='CLOSED' && s.start==='00:00' && s.end==='23:59');
		  for(const s of targets){ await api.remove(token, s.id); }
		}
		await refresh();
	  }catch(err){
		alert(err.message);
		el.checked = !el.checked;
	  }
	}
  </script>
</head>
<body class="bg-slate-900">
  <header class="sticky top-0 z-10 bg-gradient-to-r from-slate-900 to-slate-800 text-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-lg font-semibold">Admin — Phòng Khám Thành Ý</h1>
      <a href="/" class="text-white/80 hover:text-white text-sm">Trang chủ</a>
    </div>
  </header>
  <div class="relative min-h-screen bg-gradient-to-br from-slate-900 to-slate-800">
    <div class="absolute inset-0 opacity-40 bg-[radial-gradient(circle_at_20%_20%,rgba(56,189,248,0.35),transparent_40%),radial-gradient(circle_at_80%_0%,rgba(99,102,241,0.35),transparent_35%)]"></div>
    <div class="relative max-w-6xl mx-auto px-4 py-6">
    <div id="auth" class="glass border border-white/10 rounded-xl p-4 mb-4" style="display:none">
      <form name="loginForm" onsubmit="onLogin(event)">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-slate-300 text-sm mb-1">Email</label>
            <input class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="email" type="email" placeholder="admin@thanhy.vn" required />
          </div>
          <div>
            <label class="block text-slate-300 text-sm mb-1">Mật khẩu</label>
            <input class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="password" type="password" placeholder="admin123" required />
          </div>
          <div class="flex items-end">
            <button class="w-full px-4 py-2 rounded-lg bg-cyan-500 hover:bg-cyan-400 text-white font-medium" type="submit">Đăng nhập</button>
          </div>
        </div>
      </form>
    </div>

    <div id="panel" style="display:none">
      <div class="glass border border-white/10 rounded-xl p-4 mb-4">
        <form name="slotForm" onsubmit="onSubmit(event)">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="block text-slate-300 text-sm mb-1">Thứ</label>
              <select class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="weekday">
                <option value="1">Thứ 2</option>
                <option value="2">Thứ 3</option>
                <option value="3">Thứ 4</option>
                <option value="4">Thứ 5</option>
                <option value="5">Thứ 6</option>
                <option value="6">Thứ 7</option>
                <option value="0">Chủ nhật</option>
              </select>
            </div>
            <div>
              <label class="block text-slate-300 text-sm mb-1">Giờ bắt đầu</label>
              <input class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="start" type="time" required />
            </div>
            <div>
              <label class="block text-slate-300 text-sm mb-1">Giờ kết thúc</label>
              <input class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="end" type="time" required />
            </div>
            <div>
              <label class="block text-slate-300 text-sm mb-1">Trạng thái</label>
              <select class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="status">
                <option value="AVAILABLE">Mở</option>
                <option value="CLOSED">Đóng</option>
              </select>
            </div>
            <div>
              <label class="block text-slate-300 text-sm mb-1">Ghi chú</label>
              <textarea class="w-full px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" name="note" placeholder="Ghi chú thêm (nếu có)"></textarea>
            </div>
          </div>
          <div class="mt-3 flex flex-wrap gap-2 items-center">
            <button class="px-4 py-2 rounded-lg bg-cyan-500 hover:bg-cyan-400 text-white font-medium" id="submitBtn" type="submit">Thêm mới</button>
            <button class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white" type="button" onclick="document.forms.slotForm.reset();editingId=null;document.getElementById('submitBtn').textContent='Thêm mới'">Làm mới</button>
            <button class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white" type="button" onclick="logout()">Đăng xuất</button>
            <div class="flex-1"></div>
            <div class="flex items-center gap-2">
              <select id="closeDay" class="px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white">
                <option value="" selected>Đóng ngày (chọn thứ)</option>
                <option value="1">Thứ 2</option>
                <option value="2">Thứ 3</option>
                <option value="3">Thứ 4</option>
                <option value="4">Thứ 5</option>
                <option value="5">Thứ 6</option>
                <option value="6">Thứ 7</option>
                <option value="0">Chủ nhật</option>
              </select>
              <input id="closeReason" class="px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white" placeholder="Lý do nghỉ (ví dụ: Nghỉ lễ)" />
              <button type="button" class="px-4 py-2 rounded-lg bg-rose-500 hover:bg-rose-400 text-white" onclick="quickCloseDay()">Đóng ngày</button>
            </div>
          </div>
        </form>
      </div>

      <div class="glass border border-white/10 rounded-xl overflow-hidden">
        <div class="flex flex-col gap-3 p-4">
			<div class="flex items-center justify-between">
			  <div class="text-slate-200 font-medium">Tuần làm việc</div>
			  <div class="flex items-center gap-2">
				<select id="weekSelect"
						class="px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white"></select>
				<button class="px-4 py-2 rounded-lg bg-rose-600 hover:bg-rose-500 text-white"
						onclick="deleteAllSlots(false)">Xoá tất cả lịch</button>
				<button class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white"
						onclick="applyDefaults()">Áp dụng lịch mặc định</button>
			  </div>
			</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_1" type="checkbox" onchange="onToggleClosed(1,this)" class="accent-rose-500"> T2</label>
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_2" type="checkbox" onchange="onToggleClosed(2,this)" class="accent-rose-500"> T3</label>
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_3" type="checkbox" onchange="onToggleClosed(3,this)" class="accent-rose-500"> T4</label>
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_4" type="checkbox" onchange="onToggleClosed(4,this)" class="accent-rose-500"> T5</label>
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_5" type="checkbox" onchange="onToggleClosed(5,this)" class="accent-rose-500"> T6</label>
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_6" type="checkbox" onchange="onToggleClosed(6,this)" class="accent-rose-500"> T7</label>
            <label class="flex items-center gap-2 text-slate-200"><input id="toggleClose_0" type="checkbox" onchange="onToggleClosed(0,this)" class="accent-rose-500"> CN</label>
          </div>
          <div class="text-xs text-slate-400">Bật công tắc để tạo slot Đóng cửa (00:00–23:59). Tắt để mở lại ngày đó.</div>
        </div>
        <table class="w-full text-sm">
          <thead class="bg-white/10 text-slate-200">
            <tr>
              <th class="px-3 py-2 text-left">ID</th>
              <th class="px-3 py-2 text-left">Thứ</th>
              <th class="px-3 py-2 text-left">Giờ</th>
              <th class="px-3 py-2 text-left">TT</th>
              <th class="px-3 py-2 text-left">Ghi chú</th>
              <th class="px-3 py-2 text-left">Hành động</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-white/10 text-slate-100"></tbody>
        </table>
      </div>
    </div>
    </div>
  </div>

  <script>
    // Init auth view
	if(token){ document.getElementById('panel').style.display='block'; initWeekSelect(); refresh(); }
	else { document.getElementById('auth').style.display='block'; }

  </script>
</body>
</html>


